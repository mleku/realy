= realy.lol
:toc:

image:https://img.shields.io/badge/godoc-documentation-blue.svg[Documentation,link=https://pkg.go.dev/realy.lol]
image:https://img.shields.io/badge/donate-geyser_crowdfunding_project_page-orange.svg[Support this project,link=https://geyser.fund/project/realy]
zap me: ⚡️mleku@getalby.com

image:./realy.png[realy.png]

nostr relay built from a heavily modified fork of https://github.com/nbd-wtf/go-nostr[nbd-wtf/go-nostr]
and https://github.com/fiatjaf/relayer[fiatjaf/relayer] aimed at maximum performance, simplicity and memory efficiency.

== Features

* a lot of other bits and pieces accumulated from nearly 8 years of working with Go, logging and run control, user data directories (windows, mac, linux, android)
* a cleaned up and unified fork of the btcd/dcred BIP-340 signatures, including the use of bitcoin core's BIP-340 implementation (more than 4x faster than btcd)
* AVX/AVX2 optimized SHA256 and SIMD hex encoder
* https://github.com/bitcoin/secp256k1[libsecp256k1]-enabled signature and signature verification (see link:p256k/README.md[here])
* efficient, mutable byte slice based hash/pubkey/signature encoding in memory (zero allocation decode from wire)
* custom badger based event store with a garbage collector that deletes least recent once the store exceeds a specified size access, and data encoded using a more space efficient format based on the nost canonical json array event form
* vanity npub generator that can mine a 5 letter prefix in around 15 minutes on a 6 core Ryzen 5 processor
* reverse proxy tool with support for Go vanity imports and https://github.com/nostr-protocol/nips/blob/master/05.md[nip-05] npub DNS verification and own TLS certificates

== Building

If you just want to make it run from source, you should check out a tagged version.
The commits on these tags will explain what state the commit is at.
In general, the most stable versions are new minor tags, eg v1.2.0 or v1.23.0, and minor patch versions may not be stable and occasionally may not compile (not very often).

Go 1.24 or better is recommended. Go 1.23.1 is minimum required.

== Repository Policy

In general, the main `dev` branch will build, but occasionally may not.
It is where new commits are added once they are working, mostly, and allows people to easily see ongoing activity.
IT IS NOT GUARANTEED TO BE STABLE.

Use tags to pin to a specific version. Tags are in standard Go semver pattern `vX.X.X`

== CGO and secp256k1 signatures library

By default, Go will usually be configured with `CGO_ENABLED=1`.
This selects the use of the C library from bitcoin core, which does signatures and verifications much faster (4x and better) but complicates the build process as you have to install the library beforehand.
There is instructions in link:p256k/README.md[p256k/README.md] for doing this.

=== Disabling CGO

In order to disable the use of this, you must set the environment variable `CGO_ENABLED=0` and it the Go compiler will automatically revert to using the btcec based secp256k1 signatures library.

----
export CGO_ENABLED=0
cd cmd/realy
go build .
----

This will build the binary and place it in cmd/realy and then you can move it where you like.

=== Static build

To produce a static binary, whether you use the CGO secp256k1 or disable CGO as above:

----
go build --ldflags '-extldflags "-static"' -o ~/bin/realy ./cmd/realy/.
----

will place it into your `~/bin/` directory, and it will work on any system of the same architecture with the same glibc major version (has been 2 for a long time).

== Configuration

The default will run the relay with default settings, which will not be what you want.

=== Show Current Configuration

To see the current active configuration:

----
realy env
----

=== Create Persistent Configuration

This output can be directed to the profile location to make the settings editable without manually setting them on the commandline:

----
realy env > $HOME/.config/realy/.env
----

You can now edit this file to alter the configuration.

Regarding the configuration system, this is an element of many servers that is absurdly complex, and for which reason Realy does not use a complicated scheme, a simple library that allows automatic configuration of a series of options, added a simple info print:

----
realy help
----

will show you the instructions, and the one simple extension of being able to use a standard formated .env file to configure all the options for an instance.

=== Database Storage Location

The database is stored in `$HOME/.local/share/realy` and if need be you can stop `realy` delete everything in this directory and restart to "nuke" the database.

== Administrative functions

`realy` has full nip-98 support and there is a command line tool that is like `curl` but puts the correct nostr auth event into the HTTP headers found in link:cmd/curdl[`curdl`] that can be used for these functions.

To install `curdl` from source, just run `go install ./cmd/curdl/.` with your current working directory at the repository root.

To use `curdl`, first of all, you need to add your npub to the configuration of `realy` - it can be in hex or bech32 npub format at your option, see above

=== Authentication

To authenticate, you need to set the environment variable `NOSTR_SECRET_KEY=npub1...` which expects the key to be in bech32 `nsec` format. `curdl` will then use this to sign the authentication event that embeds in the HTTP header.

=== Network Address

The address to use for `curdl` commands is the same as the websocket address, which by default binds to all ports on the port 3334. By default this includes 127.0.0.1/localhost. This can be reconfigured as per the previous section by editing the environment variables file or setting environment variables.

=== Export Events

You can export everything in the event store through the default http://localhost:3334 endpoint like so:

----
curdl get http://localhost:3334/export > everything.jsonl
----

Or just all of the whitelisted users and all events with p tags with them in it:

----
curdl get http://localhost:3334/export/users > users.jsonl
----

Or just one user: (includes also matching p tags)

----
curdl get http://localhost:3334/export/4c800257a588a82849d049817c2bdaad984b25a45ad9f6dad66e47d3b47e3b2f > mleku.jsonl
----

Or several users with hyphens between the hexadecimal public keys: (ditto above)

----
curdl get http://localhost:3334/export/4c800257a588a82849d049817c2bdaad984b25a45ad9f6dad66e47d3b47e3b2f-454bc2771a69e30843d0fccfde6e105ff3edc5c6739983ef61042633e4a9561a > mleku_gojiberra.jsonl
----

=== Import Events

And import also, to put one of these files (also nostrudel and coracle have functions to export the app database of events in jsonl). Note the `post` in the command, this indicates that the filename after `post` will be uploaded to the url afterwards.

----
curdl post nostrudel.jsonl http://localhost:3334/import
----

It is not necessary but you can also optionally provide the SHA256 checksum of the file after the file and before the URL:

----
curdl post nostrudel.jsonl DEADBEEFCAFE123455566... http://localhost:3334/import
----

However, if you use `curdl` with other nip-98 auth capable HTTP endpoints they may require this, and you can do this conveniently like this:

----
curdl post nostrudel.jsonl $(sha256sum http://localhost:3334/import)
----

on a standard linux distribution.

This adds the "payload" key to the header with that hash in it. It does not verify it is correct.

=== Shutdown Remotely

You can also shut down the realy as well:

----
curl -u username:password http://localhost:3334/shutdown
----